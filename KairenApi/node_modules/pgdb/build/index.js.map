{"version":3,"sources":["webpack:///webpack/bootstrap 0feedab6f677d8ec3e6e","webpack:///./index.ts","webpack:///external \"knex\"","webpack:///./upsertMonkeyPatch.ts","webpack:///external \"knex/lib/query/compiler\""],"names":[],"mappings":"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","file":"index.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId])\n \t\t\treturn installedModules[moduleId].exports;\n\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\texports: {},\n \t\t\tid: moduleId,\n \t\t\tloaded: false\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.loaded = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"/build/\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(0);\n\n\n\n/** WEBPACK FOOTER **\n ** webpack/bootstrap 0feedab6f677d8ec3e6e\n **/","// ORM criticism\n// https://web.archive.org/web/20121020042747/http://blog.objectmentor.com/articles/2007/11/02/active-record-vs-objects\n// http://programmers.stackexchange.com/questions/119352/does-the-activerecord-pattern-follow-encourage-the-solid-design-principles\n\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator.throw(value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments)).next());\n    });\n};\n// LINQ might be an interesting model to study.\n/*\n\n+ upsert?\n  + http://stackoverflow.com/questions/17267417/how-do-i-do-an-upsert-merge-insert-on-duplicate-update-in-postgresql\n  + http://www.postgresql.org/docs/9.5/static/sql-insert.html\n+ non-emuerating uuid?\n  + uuid v1 might have better performance characteristics. it's time-based sequence, and as such won't cause table fragmentation.\n\n*/\n/*\nusing iterator to model relationship is pretty interesting...\n\nvar q =\n   from c in db.Customers\n   from o in c.Orders\n   where c.City == \"London\"\n   select new { c, o };\n*/\nconst knex = require(\"knex\");\nconst upsertMonkeyPatch_1 = require(\"./upsertMonkeyPatch\");\nfunction connect(config) {\n    if (exports.db) {\n        return;\n    }\n    console.log(\"db:\", config.connection);\n    // TODO: doesn't seem to be a way to know whether the connection succeed?\n    exports.db = knex(Object.assign({ client: \"pg\" }, config));\n    upsertMonkeyPatch_1.default(exports.db);\n    // Same as {debug: true}\n    // db.on(\"query\",(obj) => {\n    //   console.log(\"db query\", obj);\n    // });\n    // lame. not what i think it is.\n    // return new Promise<any>(resolve => {\n    //   db.once(\"start\", () => {\n    //     console.log(\"emit start dammit!\");\n    //   });\n    //   db.once(\"start\", resolve);\n    // });\n}\nexports.connect = connect;\nfunction disconnect() {\n    return __awaiter(this, void 0, Promise, function* () {\n        if (exports.db === undefined) {\n            return;\n        }\n        var err = yield exports.db.destroy();\n        exports.db = undefined;\n        return err;\n    });\n}\nexports.disconnect = disconnect;\nfunction Table(config) {\n    let { tableName, primaryKey, createTimestamp, updateTimestamp, } = config;\n    if (primaryKey === undefined) {\n        primaryKey = \"id\";\n    }\n    function timestampCreate(obj) {\n        if (createTimestamp === undefined && updateTimestamp === undefined) {\n            return obj;\n        }\n        const now = new Date();\n        const timestamps = {};\n        if (createTimestamp) {\n            timestamps[createTimestamp] = now;\n        }\n        if (updateTimestamp) {\n            timestamps[updateTimestamp] = now;\n        }\n        return Object.assign(timestamps, obj);\n    }\n    function timestampUpdate(obj) {\n        if (updateTimestamp === undefined) {\n            return obj;\n        }\n        const now = new Date();\n        const timestamps = { [updateTimestamp]: now };\n        return Object.assign(timestamps, obj);\n    }\n    class _Table {\n        all() {\n            return exports.db(tableName);\n        }\n        // get table(): Query<T> {\n        //   return db(tableName);\n        // }\n        where(obj) {\n            return this.all().where(obj);\n        }\n        whereNot(obj) {\n            return this.all().whereNot(obj);\n        }\n        find(id) {\n            return __awaiter(this, void 0, void 0, function* () {\n                return this.all().where({ [primaryKey]: id }).first();\n            });\n        }\n        insertVoid(obj) {\n            return __awaiter(this, void 0, Promise, function* () {\n                const insert = this.all().insert(timestampCreate(obj));\n                yield insert;\n                return;\n            });\n        }\n        insert(obj) {\n            return __awaiter(this, void 0, Promise, function* () {\n                const insert = this.all().insert(timestampCreate(obj)).returning(\"*\");\n                return (yield insert)[0];\n            });\n        }\n        upsert(obj, upsertUniqueColumns) {\n            return __awaiter(this, void 0, Promise, function* () {\n                const insert = this.all().insert(timestampCreate(obj)).onConflict(upsertUniqueColumns, timestampUpdate(obj)).returning(\"*\");\n                return (yield insert)[0];\n            });\n        }\n        update(key, obj) {\n            return __awaiter(this, void 0, Promise, function* () {\n                const update = this._update(key, obj).returning(\"*\");\n                return (yield update)[0];\n            });\n        }\n        updateVoid(key, obj) {\n            return __awaiter(this, void 0, Promise, function* () {\n                yield this._update(key, obj);\n                return;\n            });\n        }\n        ;\n        _update(key, obj) {\n            if (key == null) {\n                throw new Error(\"Key cannot be null for update\");\n            }\n            return this.all().where({ [primaryKey]: key }).limit(1).update(obj);\n        }\n    }\n    return new _Table();\n}\nexports.Table = Table;\n\n\n\n/** WEBPACK FOOTER **\n ** ./index.ts\n **/","module.exports = require(\"knex\");\n\n\n/*****************\n ** WEBPACK FOOTER\n ** external \"knex\"\n ** module id = 1\n ** module chunks = 0\n **/","\"use strict\";\nconst BaseQueryCompiler = require(\"knex/lib/query/compiler\");\nfunction upsertMonkeyPatch(db) {\n    // https://github.com/tgriesser/knex/issues/54#issuecomment-183838939\n    const QueryBuilder = db.client.QueryBuilder;\n    const QueryCompiler = db.client.QueryCompiler;\n    // monkey patch to add onConflict\n    QueryBuilder.prototype.onConflict = function (columns, updates) {\n        // throw error if method is not insert\n        this._single[\"onConflictUpdate\"] = {\n            columns: columns,\n            updates: updates,\n        };\n        return this;\n    };\n    const __baseInsert = BaseQueryCompiler.prototype.insert;\n    QueryCompiler.prototype.insert = function insert() {\n        let sql /*:string */ = __baseInsert.call(this);\n        if (this.single.onConflictUpdate) {\n            const { columns, updates } = this.single.onConflictUpdate;\n            sql += ` on conflict (${this.formatter.columnize(columns)}) `;\n            const doUpdate = Object.keys(updates).sort().map(key => {\n                const val = updates[key];\n                return this.formatter.wrap(key) + ' = ' + this.formatter.parameter(val);\n            }).join(\", \");\n            sql += ` do update set ${doUpdate}`;\n        }\n        var returning = this.single.returning;\n        if (returning) {\n            sql += ' returning ' + this.formatter.columnize(returning);\n        }\n        return {\n            sql: sql,\n            returning: returning,\n        };\n    };\n}\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.default = upsertMonkeyPatch;\n\n\n\n/** WEBPACK FOOTER **\n ** ./upsertMonkeyPatch.ts\n **/","module.exports = require(\"knex/lib/query/compiler\");\n\n\n/*****************\n ** WEBPACK FOOTER\n ** external \"knex/lib/query/compiler\"\n ** module id = 3\n ** module chunks = 0\n **/"],"sourceRoot":""}